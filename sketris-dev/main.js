(()=>{"use strict";var t={221:(t,e,i)=>{var s=i(643);class h{constructor(t=null,e=20,i=10,s=30,h=2){this.app=t,this.rows=e,this.cols=i,this.tileSize=s,this.spawnArea=h,this.data=null,this.container=document.getElementById("boardArea"),this.playfield=new a(this.rows,this.cols,this.tileSize,this.spawnArea),this.hold=new d(this.tileSize),this.queue=new n(this,this.hold,this.tileSize),this.sketcher=new l(this.playfield,(()=>this.getActivePiece()),(()=>this.saveState()),(()=>this.pauseActiveRender()),(()=>this.resumeActiveRender())),this.history=new c,this.activePiece=null,this.pauseActive=!1,this.isPaused=!1,this.qRegen=!0,document.getElementById("importButton").addEventListener("click",(t=>{let e=document.getElementById("importText").value;this.loadData(e);let i=document.querySelector(":focus");i&&i.blur()})),document.getElementById("clearImport").addEventListener("click",(t=>{document.getElementById("importText").value="";let e=document.querySelector(":focus");e&&e.blur()})),this.qRegenCheckbox=document.getElementById("queueRegen"),this.qRegenCheckbox.checked=this.qRegen,this.qRegenCheckbox.addEventListener("click",(t=>{this.qRegen=t.target.checked,this.updateDataPanel()}));let r=document.getElementById("holdInput");r.addEventListener("input",(t=>{this.hold.setHold(document.getElementById("holdInput").value),this.updateDataPanel()})),r.addEventListener("keydown",(t=>{"Enter"!=t.key&&"Tab"!=t.key?("Backspace"!=t.key&&"Delete"!=t.key||(this.hold.setHold(null),this.updateDataPanel()),document.getElementById("holdInput").value=""):r.blur()}));let o=document.getElementById("customQueue");o.addEventListener("input",(t=>{this.queue.edit=!0,this.queue.updateQueue(document.getElementById("customQueue").value),this.spawnPiece()})),o.addEventListener("keydown",(t=>{"Enter"==t.key&&o.blur()})),document.getElementById("copyAsLink").addEventListener("click",(t=>{let e="https://mxmoss.me/sketris/?data="+document.getElementById("exportArea").value;this.setClipboard(e),t.target.blur(),t.target.style.animationName="copyAnim",setTimeout((()=>{document.getElementById("copyAsLink").style.animationName="none"}),5e3)})),document.getElementById("copyRaw").addEventListener("click",(t=>{let e=document.getElementById("exportArea").value;this.setClipboard(e),t.target.blur(),t.target.style.animationName="copyAnim",setTimeout((()=>{document.getElementById("copyRaw").style.animationName="none"}),5e3)}))}setClipboard(t){navigator.clipboard.writeText(t).then((()=>{}),(()=>{alert("Err: failed to copy to clipboard.")}))}getData(){let t=this.playfield.getData(),e=this.queue.getData(!1),i=new ArrayBuffer;i=s.PN(s.Ov(t,t.byteLength),i),i=s.PN(s.Ov(e,e.byteLength),i);let h=new Uint8Array(1);return h[0]=1&this.qRegen,h=s.Ov(h,0),i=s.PN(s.Ov(h,h.byteLength),i),s.KW(i)}loadData(t){if(""==t)return this.data=null,void this.resetBoard();let e=this.getData();try{let e=s.mO(t),i=s.CJ(e),h=i[0];s.sU(h).num,this.qRegen=1&new Uint8Array(h)[1],this.queue.loadData(i[1]),this.playfield.loadData(i[2]),this.data=t}catch{this.loadData(e),alert("Err: Invalid Data")}}updateDataPanel(){document.getElementById("holdInput").value=this.hold.pieceName?this.hold.pieceName:"",document.getElementById("customQueue").value=this.queue.toString(),document.getElementById("exportArea").value=this.getData()}update(){this.qRegenCheckbox.checked=this.qRegen,this.isPaused||this.queue.updateQueue(),(!this.activePiece&&this.queue.getCurrent()||this.activePiece&&this.activePiece.name!==this.queue.getCurrent())&&this.spawnPiece()}lstGuide(){let t=t=>this.playfield.board.map((e=>e[t])),e=t=>{for(let e=0;e<t.length;e++)if(t[e].active)return t[e].y;return this.rows+this.spawnArea},i=[];for(let e=0;e<this.cols;e++)i.push(t(e));let s=(t,s)=>{let h=e(i[t]),a=e(i[s]),l=h>=a?i[t]:i[s],r=h>=a?i[s]:i[t],o=e(r);if(h!=a)for(let t=this.rows+this.spawnArea-1;t>=0;t--){let e=l[t];t>=o&&!e.active&&r[t].active||r[t].selected?e.selected=!0:e.selected=!1,t>=o&&(r[t].selected=!1),t<o&&(l[t].selected||r[t].selected)&&(l[t].selected=!0,r[t].selected=!0)}else for(let t=this.rows+this.spawnArea-1;t>=0;t--)l[t].selected=!1,r[t].selected=!1};s(0,4),s(1,3)}countToFourGuide(){let t=t=>this.playfield.board.map((e=>e[t])),e=t=>{for(let e=0;e<t.length;e++)if(t[e].active)return t[e].y;return this.rows+this.spawnArea},i=0;for(let s=0;s<this.playfield.cols;s++)i=Math.max(e(t(s)),i);this.playfield.ctx.fillStyle="rgba(200,200,200, 0.08)",this.playfield.ctx.fillRect(0,this.tileSize*(i-4),this.playfield.canvas.width,4*this.tileSize),this.playfield.ctx.strokeStyle="rgba(200,0,200, 0.5)",this.playfield.ctx.moveTo(0,this.tileSize*i),this.playfield.ctx.lineTo(this.playfield.canvas.width,this.tileSize*i),this.playfield.ctx.stroke()}getActivePiece(){return this.activePiece}resize(){this.tileSize=this.container.offsetWidth/30,this.playfield.tileSize=this.tileSize,this.queue.tileSize=this.tileSize,this.hold.tileSize=this.tileSize}renderBoard(){this.playfield.render(this.isPaused),this.queue.renderQueue(),this.hold.renderHold(),this.pauseActive||this.renderActive()}pauseActiveRender(){this.pauseActive=!0}resumeActiveRender(){this.pauseActive=!1}renderActive(){if(this.activePiece){let t=this.activePiece.copy(),e=s.lu(t.color);t.color="rgba("+e.r+","+e.g+","+e.b+",0.5)",this.shiftInstant("down",!1,t);for(let e=0;e<t.tiles.length;e++)this.playfield.colorTile(t.tiles[e]);for(let t=0;t<this.activePiece.tiles.length;t++)this.playfield.colorTile(this.activePiece.tiles[t])}}saveState(){this.history.addState(this.playfield,this.queue),this.updateDataPanel()}setState(t){let e=this.history.getState(t);e&&(this.playfield.loadData(e.playfieldData),this.queue.loadData(e.queueData),this.spawnPiece(!1),this.updateDataPanel(),this.sketcher.reset())}spawnPiece(t=!0,e=null){let i=Math.ceil(this.cols/2)-2;return this.queue.getCurrent()?(this.activePiece=new o(this.queue.getCurrent(),i,0),this.collisionCheck(this.activePiece,this.playfield)?(this.activePiece=null,!1):("r"===e?this.shiftInstant("right"):"l"===e&&this.shiftInstant("left"),t&&this.saveState(),!0)):(this.activePiece=null,t&&this.saveState(),!1)}holdPiece(){if(this.activePiece)if(this.hold.pieceName){let t=this.hold.getHold();this.hold.setHold(this.activePiece.name),this.queue.setCurrent(t),this.spawnPiece()}else this.hold.setHold(this.activePiece.name),this.queue.queueStep(),this.spawnPiece();else this.hold.pieceName&&(this.queue.setCurrent(this.hold.pieceName),this.hold.setHold(null),this.spawnPiece())}collisionCheck(t,e){for(let i=0;i<t.tiles.length;i++){let s=t.tiles[i];if(s.y<0||s.x<0||s.y>this.rows+this.spawnArea-1||s.x>this.cols-1||e.board[s.y][s.x].active)return!0}return!1}shiftPiece(t,e=this.activePiece){if(e){if("left"===t?e.move(0,-1):"right"===t?e.move(0,1):"down"===t&&e.move(1,0),!this.collisionCheck(e,this.playfield))return!0;"left"===t?e.move(0,1):"right"===t?e.move(0,-1):"down"===t&&e.move(-1,0)}return!1}shiftInstant(t,e=!1,i=this.activePiece){if(i)if("left"===t)for(;this.shiftPiece("left",i);)e&&this.shiftInstant("down",e,i);else if("right"===t)for(;this.shiftPiece("right",i);)e&&this.shiftInstant("down",e,i);else if("down"===t)for(;this.shiftPiece("down",i););}rotateActive(t){if(this.activePiece){let e,i=this.activePiece.rot,s=((this.activePiece.rot+t)%4+4)%4;if(this.activePiece.rotate(s),e="i"===this.activePiece.name?this.kickTable.i[i][s]:this.kickTable.n[i][s],e)for(let t=0;t<e.length;t++){let i=e[t];if(this.activePiece.move(-i[1],i[0]),!this.collisionCheck(this.activePiece,this.playfield))return!0;this.activePiece.move(i[1],-i[0])}this.activePiece.rotate(i)}return!1}hardDrop(t=this.activePiece){if(t){for(;this.shiftPiece("down",t););this.playfield.write(this.activePiece),this.playfield.clearLines(),this.queue.queueStep(),this.spawnPiece()}}resetBoard(t=!1){this.sketcher.reset(),this.data?this.loadData(this.data):(this.playfield.reset(),this.hold.setHold(""),this.queue.reset(),this.activePiece=null,this.spawnPiece())}kickTable={n:{0:{0:[[0,0]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],2:[[0,0],[0,1],[1,1],[-1,1],[1,0],[-1,0]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},1:{0:[[0,0],[1,0],[1,-1],[0,2],[1,2]],1:[[0,0]],2:[[0,0],[1,0],[1,-1],[0,2],[1,2]],3:[[0,0],[1,0],[1,2],[1,1],[0,2],[0,1]]},2:{0:[[0,0],[0,-1],[-1,-1],[1,-1],[-1,0],[1,0]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],2:[[0,0]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},3:{0:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],1:[[0,0],[-1,0],[-1,2],[-1,1],[0,2],[0,1]],2:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],3:[[0,0]]}},i:{0:{0:[[0,0]],1:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],2:[[0,0],[0,1],[1,1],[-1,1],[1,0],[-1,0]],3:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},1:{0:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],1:[[0,0]],2:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],3:[[0,0],[1,0],[1,2],[1,1],[0,2],[0,1]]},2:{0:[[0,0],[0,-1],[-1,-1],[1,-1],[-1,0],[1,0]],1:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],2:[[0,0]],3:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},3:{0:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],1:[[0,0],[-1,0],[-1,2],[-1,1],[0,2],[0,1]],2:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],3:[[0,0]]}}}}class a{constructor(t=20,e=10,i=30,s=2,h="background",a="field"){this.rows=t,this.cols=e,this.tileSize=i,this.spawnArea=s,this.garbStart=-1,this.board=[];for(let t=0;t<this.rows+this.spawnArea;t++){let e=[];for(let i=0;i<this.cols;i++)e.push(new r(i,t));this.board.push(e)}this.canvas=document.getElementById(a),this.ctx=this.canvas.getContext("2d"),this.backgroundCanvas=document.getElementById(h),this.backgroundCtx=this.backgroundCanvas.getContext("2d")}getData(){let t=["#555555"].concat(Object.entries(o.pieces).map((t=>t[1].color))),e=e=>{for(const[i,h]of t.entries())if(s.EN(h,e))return i;return!1},i=new ArrayBuffer(220,{maxByteLength:220}),h=new Uint8Array(i),a=0,l=0;for(let t=0;t<220;t++){let i=this.board[t%22][Math.floor(t/22)],s=0;(i.active||i.ghost||i.selected)&&(s=i.active<<7|i.ghost<<6|i.selected<<5|e(i.color)<<2),a>=1&&s==h[a-1]?(l+=1,219==t&&(h[a-1]=1|h[a-1],h[a]=l,a+=1,l=0)):(l&&(h[a-1]=1|h[a-1],h[a]=l,a+=1,l=0),h[a]=s,a+=1)}return h.buffer.slice(0,a)}loadData(t){this.reset();let e=new Uint8Array(t),i=0,s=["#555555"].concat(Object.entries(o.pieces).map((t=>t[1].color))),h=0;for(;h<220;)if(1&e[i]){let t=e[i+1];for(let a=0;a<t+1;a++){let t=this.board[h%22][Math.floor(h/22)],a=e[i];t.active=(128&a)>>7,t.ghost=(64&a)>>6,t.selected=(32&a)>>5,t.color=s[(28&a)>>2],h+=1}i+=2}else{let t=this.board[h%22][Math.floor(h/22)],a=e[i];t.active=(128&a)>>7,t.ghost=(64&a)>>6,t.selected=(32&a)>>5,t.color=s[(28&a)>>2],h+=1,i+=1}}setField(t){this.board=t.playfield.copy().board}getAllTiles(){let t=[];for(let e=0;e<this.rows+this.spawnArea;e++)for(let i=0;i<this.cols;i++)t.push(this.board[e][i]);return t}render(t=!1){this.boardHeight=(this.rows+this.spawnArea)*this.tileSize,this.boardWidth=this.cols*this.tileSize,this.canvas.width=this.boardWidth,this.canvas.height=this.boardHeight,this.backgroundCanvas.width=this.boardWidth,this.backgroundCanvas.height=this.boardHeight,this.backgroundCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.backgroundCtx.strokeStyle="black",this.backgroundCtx.globalAlpha=.6,this.backgroundCtx.fillRect(0,0,this.canvas.width,this.spawnArea*this.tileSize),this.backgroundCtx.globalAlpha=1,this.backgroundCtx.fillRect(0,this.spawnArea*this.tileSize,this.canvas.width,this.canvas.height),this.backgroundCtx.strokeStyle="gray",this.backgroundCtx.globalAlpha=.25,this.backgroundCtx.setLineDash([.25*this.tileSize,.5*this.tileSize,.25*this.tileSize,0]);for(let t=this.spawnArea;t<this.rows+3;t++)this.backgroundCtx.lineWidth=t===this.spawnArea||t===this.rows+this.spawnArea?1:2,this.backgroundCtx.beginPath(),this.backgroundCtx.moveTo(0,t*this.tileSize),this.backgroundCtx.lineTo(this.boardWidth,t*this.tileSize),this.backgroundCtx.stroke();for(let t=0;t<this.cols+1;t++)this.backgroundCtx.lineWidth=0===t||t===this.cols?1:2,this.backgroundCtx.beginPath(),this.backgroundCtx.moveTo(t*this.tileSize,this.spawnArea*this.tileSize),this.backgroundCtx.lineTo(t*this.tileSize,this.boardHeight),this.backgroundCtx.stroke();this.backgroundCtx.globalAlpha=1;for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&this.colorTile(i)}for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&i.selected&&(this.ctx.fillStyle="rgba(200,200,200, 1)",this.ctx.fillRect(e*this.tileSize-2,t*this.tileSize-2,this.tileSize+4,this.tileSize+4))}for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&i.selected&&this.ctx.clearRect(e*this.tileSize,t*this.tileSize,this.tileSize,this.tileSize)}for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&i.selected&&(i.active||i.ghost?this.colorTile(i):this.ctx.clearRect(e*this.tileSize,t*this.tileSize,this.tileSize,this.tileSize))}this.garbStart>=0&&(this.ctx.strokeStyle="white",this.ctx.beginPath(),this.ctx.moveTo(0,(this.garbStart+1)*this.tileSize),this.ctx.lineTo(this.boardWidth,(this.garbStart+1)*this.tileSize),this.ctx.stroke()),t&&(this.ctx.fillStyle="black",this.ctx.globalAlpha=.4,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="gray",this.ctx.globalAlpha=.6,this.ctx.fillRect(.5*this.canvas.width-30,.5*this.canvas.height-30,20,60),this.ctx.fillRect(.5*this.canvas.width+10,.5*this.canvas.height-30,20,60))}write(t){for(let e=0;e<t.tiles.length;e++){let i=t.tiles[e];this.board[i.y][i.x].active=!0,this.board[i.y][i.x].color=t.color}}colorTile(t,e=t.color){if(t.color){if(t.active)this.ctx.fillStyle=e;else{if(!t.ghost)return;{let t=s.lu(e);t.a=.4;let i="rgba("+t.r+","+t.g+","+t.b+","+t.a+")";this.ctx.fillStyle=i}}this.ctx.clearRect(t.x*this.tileSize,t.y*this.tileSize,this.tileSize,this.tileSize),this.ctx.fillRect(t.x*this.tileSize,t.y*this.tileSize,this.tileSize,this.tileSize)}}isFull(t){for(let e=0;e<t.length;e++)if(!t[e].active)return!1;return!0}clearLines(){let t=[],e=0;for(let i=this.board.length-1;i>=0;i--){let s=this.board[i];if(this.isFull(s))e+=1;else{for(let t=0;t<s.length;t++)s[t].y+=e;t.push(s)}}let i=[];for(let t=0;t<e;t++){let e=[];for(let i=0;i<this.cols;i++)e.push(new r(i,t));i.push(e)}this.board=[...i,...t.reverse()]}reset(){for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i.active=!1,i.ghost=!1,i.selected=!1,i.color=null}}copy(){let t=new a(this.rows,this.cols,this.tileSize,this.spawnArea);t.board=[];for(let e=0;e<this.rows+this.spawnArea;e++){let i=[];for(let t=0;t<this.cols;t++)i.push(this.board[e][t].copy());t.board.push(i)}return t}}class l{palette=[];magic=!0;mouseRightDown=!1;mouseMidtDown=!1;mouseLeftDown=!1;shiftKey=!1;ctrlKey=!1;altKey=!1;boardBuffer=null;garbageStart=null;drawColor="#555555";drawStartColor=null;drawMode=!1;drawRectStart;autoColorTiles=[];selected=[];selectMode=!0;selectionOffsets=[];selectRectStart;startDragTile;dragBounds={};mode=null;constructor(t,e=(()=>null),i=(()=>{}),s=(()=>{}),h=(()=>{})){this.playfield=t,this.canvas=this.playfield.canvas,this.getActivePiece=e,this.saveState=i,this.pauseActive=s,this.resumeActive=h,this.paletteOpen=!0;let a=document.getElementById("palette"),l=["rainbow","#555555"].concat(Object.entries(o.pieces).map((t=>t[1].color)));for(const[t,e]of l.entries()){let i=document.createElement("div");i.classList.add("paletteColor"),i.id=0==t?"rainbow":"color-"+t,0==t||(i.style.background=e),0==t&&i.classList.add("activeColor"),a.insertAdjacentElement("afterbegin",i),this.palette.push(i),i.addEventListener("mousedown",(t=>{"rainbow"==i.id?(this.magic=!0,this.drawColor="#555555"):(this.magic=!1,this.drawColor=t.target.style.background),this.updatePalette()}))}document.getElementById("paletteSvg").addEventListener("mousedown",(t=>{if(this.paletteOpen=!this.paletteOpen,this.paletteOpen)for(const t of document.getElementsByClassName("paletteColor"))t.style.animationName="showPalette",t.style.marginRight="0";else for(const t of document.getElementsByClassName("paletteColor"))t.style.animationName="hidePalette",t.style.marginRight="-5em"})),document.addEventListener("mousedown",(t=>{0==t.button&&(this.mouseLeftDown=!0),1==t.button&&(this.mouseMidDown=!0),2==t.button&&(this.mouseRightDown=!0),this.shiftKey=t.shiftKey,this.ctrlKey=t.ctrlKey,this.altKey=t.altKey})),document.addEventListener("mouseup",(t=>{0==t.button&&(this.mouseLeftDown=!1),1==t.button&&(this.mouseMidDown=!1),2==t.button&&(this.mouseRightDown=!1),this.shiftKey=t.shiftKey,this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.drawMode=!1,this.stopGarb()})),this.canvas.addEventListener("mousedown",(t=>{this.pauseActive(),this.shiftKey=t.shiftKey,this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,0==t.button&&(this.mouseLeftDown=!0),1==t.button&&(this.mouseMidDown=!0),2==t.button&&(this.mouseRightDown=!0),this.boardBuffer=this.playfield.copy();let e=this.getTile(t.offsetX,t.offsetY);if(e)if(1==t.button)this.mode="garbage",this.garbageStart=e.y,this.playfield.garbStart=e.y,this.garbageDraw(e);else if(t.shiftKey||t.ctrlKey)this.mode="select",this.selectMode=!e.selected,this.mouseRightDown?(this.selectRectStart=[e.x,e.y],this.selectRect(this.selectRectStart,[e.x,e.y],this.selectMode)):this.select(e,this.selectMode);else if(e.selected){this.mode="drag",this.startDragTile=e,this.selected=this.playfield.getAllTiles().filter((t=>t.selected)).map((t=>t.copy())),this.selectionOffsets=this.selected.map((t=>({x:t.x-this.startDragTile.x,y:t.y-this.startDragTile.y})),this);let t=Math.min(...this.selected.map((t=>t.x))),i=Math.min(...this.selected.map((t=>t.y))),s=Math.max(...this.selected.map((t=>t.x))),h=Math.max(...this.selected.map((t=>t.y)));this.dragBounds={lowX:this.startDragTile.x-t,highX:this.startDragTile.x+(this.playfield.cols-1)-s,lowY:this.startDragTile.y-i,highY:this.startDragTile.y+(this.playfield.rows+this.playfield.spawnArea-1)-h},this.drag(e)}else this.mode="draw",this.altKey?this.drawMode=!e.ghost:this.drawMode=!e.active,this.drawStartColor=e.color,this.mouseRightDown?(this.drawRectStart=[e.x,e.y],this.drawRect(this.drawRectStart,[e.x,e.y])):this.draw(e)})),this.canvas.addEventListener("mousemove",(t=>{let e=this.getTile(t.offsetX,t.offsetY);e&&("garbage"==this.mode?this.mouseMidDown&&this.garbageDraw(e):"draw"===this.mode?this.mouseRightDown?this.drawRect(this.drawRectStart,[e.x,e.y]):this.mouseLeftDown&&this.draw(e):"select"===this.mode?this.mouseRightDown?this.selectRect(this.selectRectStart,[e.x,e.y],this.selectMode):this.mouseLeftDown&&this.select(e,this.selectMode):"drag"===this.mode&&this.mouseLeftDown&&this.drag(e))})),this.canvas.addEventListener("mouseup",(t=>{this.resumeActive(),this.mouseRightDown&&(this.autoColorTiles=[]),0==t.button&&(this.mouseLeftDown=!1),1==t.button&&(this.mouseMidDown=!1),2==t.button&&(this.mouseRightDown=!1),this.drawMode=!1,this.getTile(t.offsetX,t.offsetY)&&("drag"===this.mode&&(this.mode="select"),"garbage"==this.mode&&(this.stopGarb(),this.mode=null),this.saveState())})),this.canvas.addEventListener("contextmenu",(t=>(t.preventDefault(),t.stopPropagation(),!1))),this.canvas.addEventListener("focusout",this.resetInputs),this.canvas.addEventListener("mouseleave",this.resumeActive),this.canvas.addEventListener("mouseenter",(()=>{this.drawMode&&this.pauseActive()}))}resetInputs(t){this.mouseLeftDown=!1,this.mouseMidDown=!1,this.mouseRightDown=!1,this.shiftKey=!1,this.ctrlKey=!1,this.altKey=!1}reset(){this.autoColorTiles=[]}getTile(t,e){let i=this.canvas.getBoundingClientRect(),s=this.canvas.width/parseFloat(i.width),h=Math.floor(t*s/this.playfield.tileSize),a=Math.floor(e*s/this.playfield.tileSize);return h=Math.min(h,this.playfield.cols-1),a=Math.min(a,this.playfield.rows+this.playfield.spawnArea-1),this.playfield.board[a][h]}isInActivePiece(t){let e=this.getActivePiece();if(e)for(let i=0;i<e.tiles.length;i++)if(t.samePos(e.tiles[i]))return!0;return!1}updatePalette(){for(const t of this.palette)this.magic&&"rainbow"==t.id||!this.magic&&s.EN(this.drawColor,t.style.background)?t.classList.add("activeColor"):t.classList.remove("activeColor")}garbageDraw(t){if(this.garbageStart>=0&&t||this.stopGarb(),t.y<=this.garbageStart){let e=t.y-this.garbageStart;for(let e=t.y+1;e<=this.garbageStart;e++){let i=[];for(let s=0;s<this.playfield.cols;s++){let h=new r(s,e);h.x!=t.x&&(h.active=!0),h.color=this.drawColor,i.push(h)}this.playfield.board[e]=i}for(let i=t.y;i>=0;i--)for(let t=0;t<this.playfield.cols;t++){let s=this.boardBuffer.board[i-e][t].copy();s.y=s.y+e,this.playfield.board[i][t]=s}}if(t.y>=this.garbageStart){let e=t.y-this.garbageStart;for(let t=0;t<e;t++)for(let e=0;e<this.playfield.cols;e++)this.playfield.board[t][e].reset();for(let i=t.y;i>=e;i--)for(let t=0;t<this.playfield.cols;t++){let s=this.boardBuffer.board[i-e][t].copy();s.y=s.y+e,this.playfield.board[i][t]=s}for(let e=this.playfield.board.length-1;e>=t.y+1;e--)for(let t=0;t<this.playfield.cols;t++){let i=this.boardBuffer.board[e][t].copy();this.playfield.board[e][t]=i}}}stopGarb(){"garbage"==this.mode&&(this.mode=null,this.garbageStart=-1,this.playfield.garbStart=-1,this.autoColorTiles=[])}autoColor(){if(this.autoColorTiles.length<4)return;this.autoColorTiles=this.autoColorTiles.filter((t=>t.active||t.ghost));let t=this.autoColorTiles,e=t=>{let e=t.map((t=>t.copy())),i=[...new Set(e.map((t=>t.y)))].toSorted(((t,e)=>t-e));for(const[t,s]of i.entries())if(0!=t)for(const h of e)h.y==s&&(h.y=i[0]+t);return e},i=(t,e)=>{let i=[];for(const a of e)i.push((s=t,h=a,Math.abs(s.x-h.x)+Math.abs(s.y-h.y)));var s,h;return i},s=(h,a)=>{if(!(t=>{if(t.length<=1)return!0;if(!(t.length<=4))return!1;{let s=e(t),h=0;for(const[t,e]of s.entries())h+=i(e,[...s.slice(0,t),...s.slice(t+1)]).reduce(((t,e)=>t+e),0);if(2==s.length&&h>6)return!1;if(3==s.length&&h>12)return!1;if(4==s.length&&h>20)return!1}return!0})(h.map((e=>t[e])))||h.length<4&&a.length<=0)return!1;if(h.length>=4)return h;let l=a.length-1;return s([...h,l],a.slice(0,a.length-1))||s(h,a.slice(0,a.length-1))},h=s([],t);if(!h)return;let a=e(h.map((e=>t[e]))),l=null;for(const t of a)(!l||t.x<l.x||t.x==l.x&&t.y<l.y)&&(l=t);let r=null;for(const[t,e]of Object.entries(o.pieces)){for(let t=0;t<4;t++){let i=e[t],s=[i[0][0]-l.y,i[0][1]-l.x],h=!0;for(const t of a){let e=[t.y+s[0],t.x+s[1]];if(!i.containsArray(e)){h=!1;break}}if(h){r=e.color;break}}if(r)break}if(r){for(const e of h.map((e=>t[e])))e.color=r;this.autoColorTiles=this.autoColorTiles.filter((function(t,e){return-1==h.indexOf(e)}))}}draw(t){if(!this.isInActivePiece(t)||!this.drawMode){if(!this.magic||!this.drawMode||t.active||t.ghost||this.autoColorTiles.includes(t)||this.autoColorTiles.push(t),this.altKey){if(this.magic&&t.ghost==this.drawMode)return;t.ghost=this.drawMode,t.active=!1}else{if(this.magic&&t.active==this.drawMode)return;t.active=this.drawMode,t.ghost=this.drawMode}t.color=this.drawMode?this.drawColor:null,this.magic&&s.EN("#555555",this.drawColor)&&(null==this.drawStartColor||s.EN(this.drawStartColor,"#555555"))&&!this.mouseRightDown&&this.autoColor()}}drawRect(t,e){let i=Math.min(t[0],e[0]),s=Math.min(t[1],e[1]),h=Math.max(t[0],e[0]),a=Math.max(t[1],e[1]);for(let t=s;t<=a;t++)for(let e=i;e<=h;e++){let i=this.playfield.board[t][e];this.draw(i)}}select(t,e=!0){(this.shiftKey||this.ctrlKey)&&(this.mouseLeftDown||this.mouseRightDown)&&(t.selected=e)}selectRect(t,e,i){let s=Math.min(t[0],e[0]),h=Math.min(t[1],e[1]),a=Math.max(t[0],e[0]),l=Math.max(t[1],e[1]);for(let t=h;t<=l;t++)for(let e=s;e<=a;e++){let s=this.playfield.board[t][e];s&&this.select(s,i)}}unselectAll(){let t=this.playfield.getAllTiles();for(let e=0;e<t.length;e++)t[e].selected=!1}drag(t){if(t!==this.startDragTile){let e=s.uZ(t.x,this.dragBounds.lowX,this.dragBounds.highX),i=s.uZ(t.y,this.dragBounds.lowY,this.dragBounds.highY);for(const t of this.boardBuffer.getAllTiles())t.selected?this.playfield.board[t.y][t.x].reset():this.playfield.board[t.y][t.x]=this.boardBuffer.board[t.y][t.x].copy();for(let t=0;t<this.selected.length;t++){this.selected[t].x=e+this.selectionOffsets[t].x,this.selected[t].y=i+this.selectionOffsets[t].y;let s=this.selected[t].copy();this.playfield.board[s.y][s.x]=s}}}}class r{constructor(t,e,i=!1,s=null){this.x=t,this.y=e,this.active=i,this.color=s,this.selected=!1,this.ghost=!1}samePos(t){return this.x===t.x&&this.y===t.y}copy(){let t=new r(this.x,this.y,this.active,this.color);return t.selected=this.selected,t.ghost=this.ghost,t}static isSame(t,e){return t.x==e.x&t.y==e.y&t.active==e.active&t.ghost==e.ghost&t.selected==e.selected}reset(){this.active=!1,this.color=null,this.selected=!1,this.ghost=!1}}class o{constructor(t,e=0,i=0,s=0){this.name=t,this.pos={x:e,y:i},this.rot=s,this.offsets=o.pieces[this.name][this.rot],this.color=o.pieces[this.name].color,this.updateTiles()}copy(){return new o(this.name,this.pos.x,this.pos.y,this.rot)}move(t,e){this.pos.y+=t,this.pos.x+=e,this.updateTiles()}rotate(t){this.rot=t,this.offsets=o.pieces[this.name][this.rot],this.updateTiles()}updateTiles(){this.tiles=this.offsets.map((t=>new r(this.pos.x+t[1],this.pos.y+t[0],!0,this.color)))}static pieces={i:{0:[[1,0],[1,1],[1,2],[1,3]],1:[[0,2],[1,2],[2,2],[3,2]],2:[[2,0],[2,1],[2,2],[2,3]],3:[[0,1],[1,1],[2,1],[3,1]],color:"#0f9bd7"},j:{0:[[0,0],[1,0],[1,1],[1,2]],1:[[0,1],[0,2],[1,1],[2,1]],2:[[1,0],[1,1],[1,2],[2,2]],3:[[2,0],[2,1],[1,1],[0,1]],color:"#2141c6"},l:{0:[[1,0],[1,1],[1,2],[0,2]],1:[[0,1],[1,1],[2,1],[2,2]],2:[[1,0],[1,1],[1,2],[2,0]],3:[[0,0],[2,1],[1,1],[0,1]],color:"#e35b02"},o:{0:[[0,1],[0,2],[1,1],[1,2]],1:[[0,1],[0,2],[1,1],[1,2]],2:[[0,1],[0,2],[1,1],[1,2]],3:[[0,1],[0,2],[1,1],[1,2]],color:"#e39f02"},s:{0:[[1,0],[1,1],[0,1],[0,2]],1:[[0,1],[1,1],[1,2],[2,2]],2:[[2,0],[2,1],[1,1],[1,2]],3:[[0,0],[1,0],[1,1],[2,1]],color:"#59b101"},t:{0:[[1,0],[0,1],[1,1],[1,2]],1:[[0,1],[1,1],[1,2],[2,1]],2:[[1,0],[1,1],[1,2],[2,1]],3:[[1,0],[0,1],[1,1],[2,1]],color:"#af298a"},z:{0:[[0,0],[0,1],[1,1],[1,2]],1:[[1,1],[0,2],[1,2],[2,1]],2:[[1,0],[1,1],[2,1],[2,2]],3:[[1,0],[2,0],[0,1],[1,1]],color:"#d70f37"}}}class n{pieces=["i","j","l","t","s","z","o"];queue=[];queueIndex=0;customPieces=0;regen=!0;slots=5;slotSizeY=3;slotSizeX=6;showMax=5;constructor(t,e,i=30){this.gameBoard=t,this.hold=e,this.edit=!1,this.canvas=document.getElementById("queue"),this.ctx=this.canvas.getContext("2d"),this.tileSize=i,this.updateQueue(),this.renderQueue()}getData(t=!0){let e=Object.entries(o.pieces).map((t=>t[0])),i=t=>{for(const[i,s]of e.entries())if(s==t)return i;return!1},h=new ArrayBuffer,a=t?this.queue:this.queue.slice(this.queueIndex),l=new Uint8Array(Math.ceil(a.length/2));for(const[t,e]of a.entries()){let s=t%2==0?4:0,h=l[Math.floor(t/2)];h|=i(e)<<s,l[Math.floor(t/2)]=h}return h=s.PN(l.buffer,h),h=s.Ov(h,a.length),h=s.Ov(h,t?this.queueIndex:0),h=s.Ov(h,this.customPieces),l=new Uint8Array(1),l[0]=(this.hold.pieceName&&1)<<7|i(this.hold.pieceName)<<4,h=s.PN(l.buffer,h),h}loadData(t){let e=Object.entries(o.pieces).map((t=>t[0])),i=[],h=new Uint8Array(t),a=h[0];this.hold.pieceName=128&a?e[(112&a)>>4]:null,t=t.slice(1);let l=s.sU(t);this.customPieces=l.num,t=l.buffer,l=s.sU(t),this.queueIndex=l.num,t=l.buffer,l=s.sU(t);let r=l.num;t=l.buffer,h=new Uint8Array(t);for(let t=0;t<r;t++){let s=t%2==0?4:0,a=t%2==0?112:7,l=h[Math.floor(t/2)];i.push(e[(l&a)>>s])}this.queue=i}toString(){return this.queue.slice(this.queueIndex).join("")}formatString(t){let e="",i=0;for(const s of t.trim())i>=7?(e+="\n",i=0):(e+=s,i++);return e=e.replace(/(\s)\1{2,}/g,"\n"),e}copy(){let t=new n(this.tileSize);return t.queue=structuredClone(this.queue),t.queueIndex=this.queueIndex,t}renderQueue(){this.queueHeight=this.tileSize*this.slots*this.slotSizeY+this.tileSize,this.queueWidth=this.tileSize*this.slotSizeX,this.canvas.height=this.queueHeight,this.canvas.width=this.queueWidth,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.slots;t++)t<this.showMax&&this.queue[this.queueIndex+t+1]&&this.drawPiece(new o(this.queue[this.queueIndex+t+1]),this.tileSize,t*this.slotSizeY*this.tileSize+this.tileSize);for(let t=0;t<7;t++)this.ctx.lineWidth=4,this.ctx.strokeStyle=(this.queueIndex-((this.hold.pieceName?1:0)+this.customPieces+t))%7==0?"rgba(200,200,200,0.4)":"rgba(100,100,100,0.3)",this.ctx.beginPath(),this.ctx.moveTo(t*(this.queueWidth/7)+5,0),this.ctx.lineTo((t+1)*(this.queueWidth/7)-5,0),this.ctx.stroke()}drawPiece(t,e,i){for(let s=0;s<t.offsets.length;s++){let h=t.offsets[s],a=e+h[1]*this.tileSize,l=i+h[0]*this.tileSize;this.ctx.fillStyle=t.color,this.ctx.fillRect(a,l,this.tileSize,this.tileSize)}}updateQueue(t=null){if(null!==t){let e=!0,i=t.replace(/\s/g,"").toLowerCase().split(""),s=["i","j","l","t","s","z","o"];for(let t=0;t<i.length;t++)if(!s.includes(i[t])){e=!1;break}e&&(this.customPieces=i.length,this.queue=[...this.queue.slice(0,this.queueIndex),...i])}else if(!this.edit){for(;this.gameBoard.qRegen&&this.queue.length-(this.queueIndex+1)<=this.showMax;){let t=t=>{let e=structuredClone(t);for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e};this.queue.push(...t(Object.entries(o.pieces).map((t=>t[0]))))}return!0}}setQueueIndex(t){this.queueIndex=t}queueStep(){this.edit=!1,this.updateQueue(),this.queueIndex+=1}getCurrent(){return this.queue[this.queueIndex]}setCurrent(t){this.queue[this.queueIndex]=t}reset(){this.queue=[],this.queueIndex=0,this.customPieces=0,this.updateQueue()}}class d{pieceName;constructor(t=30){this.canvas=document.getElementById("hold"),this.ctx=this.canvas.getContext("2d"),this.tileSize=t,this.renderHold()}copy(){let t=new d(this.tileSize);return t.pieceName=this.pieceName,t}renderHold(){this.holdHeight=4*this.tileSize,this.holdWidth=6*this.tileSize,this.canvas.height=this.holdHeight,this.canvas.width=this.holdWidth,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.pieceName&&this.drawPiece(new o(this.pieceName),this.tileSize,this.tileSize)}drawPiece(t,e,i){for(let s=0;s<t.offsets.length;s++){let h=t.offsets[s],a=e+h[1]*this.tileSize,l=i+h[0]*this.tileSize;this.ctx.fillStyle=t.color,this.ctx.fillRect(a,l,this.tileSize,this.tileSize)}}getHold(){return this.pieceName}setHold(t){t?["i","j","l","t","s","z","o"].includes(t.toLowerCase())&&(this.pieceName=t.toLowerCase()):this.pieceName=null}}class c{states=[];stateIndex=null;addState(t,e){this.stateIndex<this.states.length-1&&(this.states=this.states.slice(0,this.stateIndex+1));let i={playfieldData:t.getData(),queueData:e.getData()};this.states.push(i),null!==this.stateIndex?this.stateIndex+=1:this.stateIndex=0}getState(t=0){if(null!==this.stateIndex)return this.stateIndex=Math.max(Math.min(this.stateIndex+t,this.states.length-1),0),this.states[this.stateIndex]}reset(){this.states=[],this.stateIndex=null}}class u{keysDown={};lastKey=null;constructor(t){window.addEventListener("keydown",(t=>this.keyDown(t))),window.addEventListener("keyup",(t=>this.keyUp(t))),document.getElementById("field").addEventListener("focusout",this.resetInputs),this.callback=t}resetInputs(t){this.keysDown={},this.lastKey=null}keyDown(t){this.keysDown[t.code]||(this.keysDown[t.code]=performance.now(),this.lastKey=t.code,this.callback(t.code,!0))}keyUp(t){this.keysDown[t.code]=null,this.callback(t.code,!1)}}class g{das=130;arr=50;softDrop=50;defaults={leftKey:"ArrowLeft",rightKey:"ArrowRight",softKey:"ArrowDown",hardKey:"Space",holdKey:"KeyC",ccrKey:"KeyZ",crKey:"ArrowUp",r180Key:"KeyA",restartKey:"KeyR",undoKey:"KeyQ",redoKey:"KeyW"};keybinds=structuredClone(this.defaults);constructor(t,e,i,s){this.input=t,this.pause=e,this.resume=i,this.board=s,this.loadSettings(),document.getElementById("settings");for(const[t,e]of Object.entries(this))if("das"===t||"arr"===t||"softDrop"===t){let i=document.getElementById(t+"Slider"),s=document.getElementById(t+"SliderVal");i.value=e,s.innerHTML=0==e?"Instant":e+" ms",i.addEventListener("input",(t=>{s.innerHTML=0==t.target.value?"Instant":t.target.value+" ms"})),i.addEventListener("change",(e=>{s.innerHTML=0==e.target.value?"Instant":e.target.value+" ms",this.update(t,e.target.value),this.saveSettings(),e.target.blur()}))}document.getElementById("resetAll").addEventListener("click",(t=>{this.keybinds=structuredClone(this.defaults),this.updateDisplay()})),document.getElementById("changeAll").addEventListener("click",(t=>this.changeAllKeys()));for(const[t,e]of Object.entries(this.keybinds))document.getElementById(t+"Button").addEventListener("click",(e=>{document.getElementById(t+"Button").blur(),this.updateKey(t)}));this.updateDisplay()}loadSettings(){let t=decodeURIComponent(document.cookie).split("; ").find((t=>t.startsWith("settings=")));if(t){let e=JSON.parse(t.split("=")[1]);this.das=e.das,this.arr=e.arr,this.softDrop=e.softDrop,this.keybinds=e.keybinds}}saveSettings(){let t={das:this.das,arr:this.arr,softDrop:this.softDrop,keybinds:this.keybinds},e=new Date;e.setTime(e.getTime()+31536e6),document.cookie="settings="+encodeURIComponent(JSON.stringify(t))+"; expires="+e.toUTCString()+"; SameSite=None; secure"}updateDisplay(){for(const[t,e]of Object.entries(this.keybinds)){let i=e;"Key"==e.slice(0,3)&&(i=i.slice(3)),document.getElementById(t+"Text").innerHTML=i}this.saveSettings()}async changeAllKeys(){for(const[t,e]of Object.entries(this.keybinds)){let e=document.getElementById(t+"Text");e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),e.innerHTML="Waiting...";let i=await this.awaitKey();this.keybinds[t]=i,this.updateDisplay()}document.getElementById("changeAll").blur()}update(t,e){this[t]=parseInt(e)}async updateKey(t){this.pause(),document.getElementById(t+"Text").innerHTML="Waiting...";let e=await this.awaitKey();this.keybinds[t]=e,this.resume(),this.updateDisplay()}awaitKey(){return new Promise((t=>{document.addEventListener("keydown",(e=>{e.preventDefault(),t(e.code)}),{once:!0})}))}}class f{active=!1;dragging=null;highlightSlider=null;sliderLen=40;sliderWid=10;sliderColor="rgba(150,150,150,1)";sliderHighlightColor="rgba(220,220,220,1)";constructor(t){this.gameBoard=t,this.preview=new a(20,10,30,2,"previewBackground","previewField"),this.imgCanvas=document.getElementById("imageCanvas"),this.imgCtx=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),this.ctrlsCanvas=document.getElementById("imageControls"),this.ctrlsCtx=this.ctrlsCanvas.getContext("2d"),this.pasterAccept=document.getElementById("pasterAccept"),this.pasterAccept.addEventListener("click",(t=>{this.active&&this.accept()})),this.pasterCancel=document.getElementById("pasterCancel"),this.pasterCancel.addEventListener("click",(t=>{this.active&&this.cancel()})),document.addEventListener("paste",(t=>{if(!t.clipboardData.getData("text")&&(this.openModal(),t.clipboardData.files.length>0)){let e=t.clipboardData.files[0],i=new FileReader;i.onload=t=>{this.img=new Image,this.img.onload=()=>{this.imgCanvas=document.getElementById("imageCanvas"),this.imgCanvas.width=.4*window.innerWidth*.8,this.imgCanvas.height=.8*window.innerHeight*.8,this.imgCtx=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),this.imgBounds={p1:{x:0,y:0},p2:{x:this.imgCanvas.width,y:this.imgCanvas.height}},this.ctrlsCanvas=document.getElementById("imageControls"),this.ctrlsCanvas.width=.4*window.innerWidth*.8,this.ctrlsCanvas.height=.8*window.innerHeight*.8,this.ctrlsCtx=this.ctrlsCanvas.getContext("2d");let t=Math.min(this.imgCanvas.width/this.img.width,this.imgCanvas.height/this.img.height),e=this.img.width*t,i=this.img.height*t,s=this.imgCanvas.width/2-e/2,h=this.imgCanvas.height/2-i/2;this.imgBounds={p1:{x:s,y:h},p2:{x:s+e,y:h+i}},this.top=Math.max(this.sliderWid/2,this.imgBounds.p1.y),this.bottom=Math.min(this.imgCanvas.height-this.sliderWid/2,this.imgBounds.p2.y),this.left=Math.max(this.sliderWid/2,this.imgBounds.p1.x),this.right=Math.min(this.imgCanvas.width-this.sliderWid/2,this.imgBounds.p2.x),this.drawImage(),this.update(),this.render()},this.img.src=t.target.result},i.readAsDataURL(e)}})),this.ctrlsCanvas.addEventListener("mousedown",(t=>{let e=this.ctrlsCanvas.getBoundingClientRect(),i=this.ctrlsCanvas.width/parseFloat(e.width),h=t.offsetX*i,a=t.offsetY*i;Math.abs(h-(this.left+(this.right-this.left)/2))<this.sliderLen+5&&Math.abs(a-this.top)<this.sliderWid+5?(this.dragging="top",this.highlight="top",this.top=s.uZ(a,this.sliderWid/2,this.bottom-this.sliderWid)):Math.abs(h-(this.left+(this.right-this.left)/2))<this.sliderLen+5&&Math.abs(a-this.bottom)<this.sliderWid+5?(this.dragging="bottom",this.highlight="bottom",this.bottom=s.uZ(a,this.top+this.sliderWid,this.imgCanvas.height-this.sliderWid/2)):Math.abs(a-(this.top+(this.bottom-this.top)/2))<this.sliderLen+5&&Math.abs(h-this.left)<this.sliderWid+5?(this.dragging="left",this.highlight="left",this.left=s.uZ(h,this.sliderWid/2,this.right-this.sliderWid)):Math.abs(a-(this.top+(this.bottom-this.top)/2))<this.sliderLen+5&&Math.abs(h-this.right)<this.sliderWid+5&&(this.dragging="right",this.highlight="right",this.right=s.uZ(h,this.left+this.sliderWid,this.imgCanvas.width-this.sliderWid/2))})),this.ctrlsCanvas.addEventListener("mousemove",(t=>{let e=this.ctrlsCanvas.getBoundingClientRect(),i=this.ctrlsCanvas.width/parseFloat(e.width),h=t.offsetX*i,a=t.offsetY*i;"top"==this.dragging||Math.abs(h-(this.left+(this.right-this.left)/2))<this.sliderLen+5&&Math.abs(a-this.top)<this.sliderWid+5?this.highlight="top":"bottom"==this.dragging||Math.abs(h-(this.left+(this.right-this.left)/2))<this.sliderLen+5&&Math.abs(a-this.bottom)<this.sliderWid+5?this.highlight="bottom":"left"==this.dragging||Math.abs(a-(this.top+(this.bottom-this.top)/2))<this.sliderLen+5&&Math.abs(h-this.left)<this.sliderWid+5?this.highlight="left":"right"==this.dragging||Math.abs(a-(this.top+(this.bottom-this.top)/2))<this.sliderLen+5&&Math.abs(h-this.right)<this.sliderWid+5?this.highlight="right":this.highlight=null,"top"==this.dragging?this.top=s.uZ(a,this.sliderWid/2,this.bottom-this.sliderWid):"bottom"==this.dragging?this.bottom=s.uZ(a,this.top+this.sliderWid,this.imgCanvas.height-this.sliderWid/2):"left"==this.dragging?this.left=s.uZ(h,this.sliderWid/2,this.right-this.sliderWid):"right"==this.dragging&&(this.right=s.uZ(h,this.left+this.sliderWid,this.imgCanvas.width-this.sliderWid/2))})),document.addEventListener("mouseup",(t=>{this.dragging&&this.update(),this.dragging=null})),document.getElementById("pasterOverlay").addEventListener("mousedown",(t=>{this.closeModal()})),document.getElementById("pasterModal").addEventListener("mousedown",(t=>{t.stopPropagation()}))}update(){for(let t=0;t<this.preview.rows;t++)for(let e=0;e<this.preview.cols;e++){let i=[(this.right-this.left)/this.preview.cols,(this.bottom-this.top)/this.preview.rows],h=this.preview.board[t+this.preview.spawnArea][e],a=this.left+i[0]*e+i[0]/2,l=this.top+i[1]*t+i[1]/2,r=s.lu(this.getPixelColor(a,l)),n=Object.entries(o.pieces).map((t=>t[1].color)).concat(["#555555","#000000"]);r.r+r.g+r.b<50||0==r.a?h.active=!1:(h.color=this.getPixelColor(a,l),h.active=!0);let d=null,c=null;for(const t of n){let e=s.wC(r,s.lu(t));"#0f9bd7"==t&&(e-=15),(!d||c>e)&&(d=t,c=e)}"#000000"==d||0==r.a?h.active=!1:(h.color=d,h.active=!0)}}drawImage(){let t=Math.min(this.imgCanvas.width/this.img.width,this.imgCanvas.height/this.img.height),e=this.img.width*t,i=this.img.height*t,s=this.imgCanvas.width/2-e/2,h=this.imgCanvas.height/2-i/2;this.imgBounds={p1:{x:s,y:h},p2:{x:s+e,y:h+i}},this.imgCtx.drawImage(this.img,this.imgBounds.p1.x,this.imgBounds.p1.y,this.imgBounds.p2.x-this.imgBounds.p1.x,this.imgBounds.p2.y-this.imgBounds.p1.y)}render(){if(this.active&&this.img){this.preview.render(),this.drawImage(),this.ctrlsCtx.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),this.ctrlsCtx.fillStyle="rgba(50,54,69,0.5)",this.ctrlsCtx.fillRect(0,0,this.imgCanvas.width,this.top),this.ctrlsCtx.fillRect(0,this.bottom,this.imgCanvas.width,this.imgCanvas.height),this.ctrlsCtx.fillRect(0,this.top,this.left,this.bottom-this.top),this.ctrlsCtx.fillRect(this.right,this.top,this.imgCanvas.width,this.bottom-this.top),this.ctrlsCtx.strokeStyle="white",this.ctrlsCtx.setLineDash([10,10]),this.ctrlsCtx.beginPath(),this.ctrlsCtx.moveTo(0,this.top),this.ctrlsCtx.lineTo(this.imgCanvas.width,this.top),this.ctrlsCtx.moveTo(0,this.bottom),this.ctrlsCtx.lineTo(this.imgCanvas.width,this.bottom),this.ctrlsCtx.moveTo(this.left,0),this.ctrlsCtx.lineTo(this.left,this.imgCanvas.height),this.ctrlsCtx.moveTo(this.right,0),this.ctrlsCtx.lineTo(this.right,this.imgCanvas.height),this.ctrlsCtx.stroke(),this.ctrlsCtx.setLineDash([]),this.ctrlsCtx.fillStyle="top"==this.highlight?this.sliderHighlightColor:this.sliderColor,this.ctrlsCtx.fillRect(this.left+(this.right-this.left)/2-this.sliderLen/2,this.top-this.sliderWid/2,this.sliderLen,this.sliderWid),this.ctrlsCtx.fillStyle="bottom"==this.highlight?this.sliderHighlightColor:this.sliderColor,this.ctrlsCtx.fillRect(this.left+(this.right-this.left)/2-this.sliderLen/2,this.bottom-this.sliderWid/2,this.sliderLen,this.sliderWid),this.ctrlsCtx.fillStyle="left"==this.highlight?this.sliderHighlightColor:this.sliderColor,this.ctrlsCtx.fillRect(this.left-this.sliderWid/2,this.top+(this.bottom-this.top)/2-this.sliderLen/2,this.sliderWid,this.sliderLen),this.ctrlsCtx.fillStyle="right"==this.highlight?this.sliderHighlightColor:this.sliderColor,this.ctrlsCtx.fillRect(this.right-this.sliderWid/2,this.top+(this.bottom-this.top)/2-this.sliderLen/2,this.sliderWid,this.sliderLen);for(let t=0;t<this.preview.rows;t++)for(let e=0;e<this.preview.cols;e++){let i=[(this.right-this.left)/this.preview.cols,(this.bottom-this.top)/this.preview.rows],s=this.left+i[0]*e+i[0]/2,h=this.top+i[1]*t+i[1]/2;this.ctrlsCtx.fillStyle="rgba(255,255,255,0.5)",this.ctrlsCtx.beginPath(),this.ctrlsCtx.arc(s,h,1,0,2*Math.PI),this.ctrlsCtx.fill()}}}getPixelColor(t,e){if(!t||!e)return"rgba(0,0,0,0)";let i=this.imgCtx.getImageData(t,e,1,1).data;return`rgba(${i[0]}, ${i[1]}, ${i[2]}, ${i[3]/255})`}accept(){this.gameBoard.playfield.loadData(this.preview.getData()),this.gameBoard.saveState(),this.closeModal(),this.active=!1}cancel(){this.closeModal(),this.active=!1}openModal(){this.active=!0,document.getElementById("pasterOverlay").style.display="block"}closeModal(){this.active=!1,document.getElementById("pasterOverlay").style.display="none"}}let p=new class{start=!0;startTime;takingInput=!0;curDir;dasFired=!1;softDrop=!1;dasCancel;arrCancel;softCancel;peer=null;conn=null;constructor(){this.input=new u(((t,e)=>this.handleInputs(t,e))),this.board=new h(this,20,10,30),this.settings=new g(this.input,(()=>this.pauseInput()),(()=>this.resumeInput()),this.board),this.paster=new f(this.board),this.panelOpen=!0,this.lastTick=performance.now(),this.lastRender=this.lastTick,this.tickLength=17;let t=window.location.href,e=new URLSearchParams(t.split("?")[1]);e.has("data")&&this.board.loadData(e.get("data")),document.getElementById("changeLogSvg").addEventListener("click",(t=>{document.getElementById("changeLogOverlay").style.display="block"})),document.getElementById("changeLogCloseSvg").addEventListener("click",(t=>{document.getElementById("changeLogOverlay").style.display="none"})),document.getElementById("panelTab").addEventListener("click",(t=>{let e=document.getElementById("panelIconLeft");e.style.animationName=this.panelOpen?"collapseIcon":"expandIcon",e.style.width=this.panelOpen?"0%":"55%";let i=document.getElementById("panelIconRight");i.style.animationName=this.panelOpen?"expandIcon":"collapseIcon",i.style.width=this.panelOpen?"55%":"0%",document.getElementById("panelTab").style.boxShadow=this.panelOpen?"0 0 10px black":"0 0 30px black";let s=document.getElementById("sidePanel");s.style.animationName=this.panelOpen?"collapsePanel":"expandPanel",s.style.width=this.panelOpen?"0":"30em",this.panelOpen=!this.panelOpen}));let i=document.getElementById("sidePanelContent");i.addEventListener("focusin",(t=>this.pauseInput())),i.addEventListener("focusout",(t=>this.resumeInput()));let s=document.getElementsByClassName("tab");for(const t of s)t.addEventListener("mousedown",(t=>{if(!t.currentTarget.classList.contains("activeTab")){let e=document.getElementsByClassName("tab");for(const t of e)t.classList.remove("activeTab"),document.getElementById(t.id.replace("Tab","")).style.display="none";t.currentTarget.classList.add("activeTab"),document.getElementById(t.currentTarget.id.replace("Tab","")).style.display="flex"}}));document.getElementById("boardArea").focus()}sendData(){this.conn&&this.conn.send(this.board.getData())}receiveData(t){this.board.loadData(t)}update(){this.start&&(this.takingInput?(this.board.isPaused=!1,this.board.update()):this.board.isPaused=!0,this.dasFired&&0===this.settings.arr&&this.board.shiftInstant(this.curDir))}initiateDas(t,e){this.cancelDas(),this.curDir=e,this.board.shiftPiece(e),this.dasCancel=setTimeout((()=>{this.dasFired=!0,this.input.keysDown[t]?0===this.settings.arr?this.board.shiftInstant(e,0===this.settings.softDrop&&this.softDrop):this.arrCancel=setInterval((()=>{this.input.keysDown[t]?this.board.shiftPiece(e):this.cancelDas()}),this.settings.arr):this.cancelDas()}),this.settings.das)}cancelDas(){this.dasCancel&&clearTimeout(this.dasCancel),this.arrCancel&&clearInterval(this.arrCancel),this.dasFired=!1,this.dasCancel=null,this.arrCancel=null,this.curDir=null}handleInputs(t,e){this.takingInput&&("Escape"===t&&(this.board.sketcher.unselectAll(),this.paster.closeModal()),"Enter"===t&&this.paster.active&&(this.paster.accept(),this.board.updateDataPanel()),t===this.settings.keybinds.leftKey?e?this.initiateDas(t,"left"):"left"===this.curDir&&this.cancelDas():t===this.settings.keybinds.rightKey?e?this.initiateDas(t,"right"):"right"===this.curDir&&this.cancelDas():t===this.settings.keybinds.softKey?e?(this.softDrop=!0,this.softCancel=setInterval((()=>{this.input.keysDown[t]?0===this.settings.softDrop?this.board.shiftInstant("down"):this.board.shiftPiece("down"):clearInterval(this.softCancel)}),this.settings.softDrop)):this.softDrop&&(this.softDrop=!1,clearInterval(this.softCancel)):e&&t===this.settings.keybinds.hardKey?this.board.hardDrop():e&&t===this.settings.keybinds.holdKey?this.board.holdPiece():e&&t===this.settings.keybinds.crKey?this.board.rotateActive(1):e&&t===this.settings.keybinds.ccrKey?this.board.rotateActive(-1):e&&t===this.settings.keybinds.r180Key?this.board.rotateActive(2):e&&t===this.settings.keybinds.restartKey?this.startGame():e&&t===this.settings.keybinds.undoKey?this.board.setState(-1):e&&t===this.settings.keybinds.redoKey&&this.board.setState(1))}render(){this.board.renderBoard(),this.paster.render()}startGame(){this.startTime=performance.now(),this.board.resetBoard(),this.start=!0}pauseInput(){this.takingInput=!1}resumeInput(){this.takingInput=!0}};!function t(e){p.stopId=window.requestAnimationFrame(t);let i=0;if(e>p.lastTick+p.tickLength){const t=e-p.lastTick;i=Math.floor(t/p.tickLength)}for(let t=0;t<i;t++)p.lastTick+=p.tickLength,p.update(p.lastTick);p.render()}(performance.now())},643:(t,e,i)=>{i.d(e,{uZ:()=>s,EN:()=>a,KW:()=>o,sU:()=>c,wC:()=>l,Ov:()=>d,PN:()=>g,lu:()=>h,CJ:()=>u,mO:()=>n}),Math.floor,String.fromCharCode;let s=(t,e,i)=>Math.max(Math.min(t,i),e),h=t=>{return"#"==t[0]&&7==t.length?{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16),a:1}:0==t.indexOf("rgba(")?{r:(e=(t=t.match(/rgba\(([^)]+)\)/)[1]).split(/ *, */).map(Number))[0],g:e[1],b:e[2],a:e[3]}:0==t.indexOf("rgb(")?{r:(e=(t=t.match(/rgb\(([^)]+)\)/)[1]).split(/ *, */).map(Number))[0],g:e[1],b:e[2],a:1}:void 0;var e};function a(t,e){if(!t||!e)return!1;const i=t=>{if("r"!=t[0])return!1;let[e,i,s]=t.split("(")[1].split(")")[0].split(",").map((t=>parseInt(t)));return"#"+[e,i,s].map((t=>{const e=t.toString(16);return 1===e.length?"0"+e:e})).join("")};return t==e||i(t)==e||i(e)==t}function l(t,e){let i=r(t),s=r(e),h=i[0]-s[0],a=i[1]-s[1],l=i[2]-s[2],o=Math.sqrt(i[1]*i[1]+i[2]*i[2]),n=o-Math.sqrt(s[1]*s[1]+s[2]*s[2]),d=a*a+l*l-n*n;d=d<0?0:Math.sqrt(d);let c=h/1,u=n/(1+.045*o),g=d/(1+.015*o),f=c*c+u*u+g*g;return f<0?0:Math.sqrt(f)}function r(t){let e,i,s,h=t.r/255,a=t.g/255,l=t.b/255;return h=h>.04045?Math.pow((h+.055)/1.055,2.4):h/12.92,a=a>.04045?Math.pow((a+.055)/1.055,2.4):a/12.92,l=l>.04045?Math.pow((l+.055)/1.055,2.4):l/12.92,e=(.4124*h+.3576*a+.1805*l)/.95047,i=(.2126*h+.7152*a+.0722*l)/1,s=(.0193*h+.1192*a+.9505*l)/1.08883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,[116*i-16,500*(e-i),200*(i-s)]}function o(t){let e=new Uint8Array(t),i="";for(let t=0;t<e.length;t++){let s=e[t];i+=String.fromCharCode(s)}return function(t){let e=window.btoa(t);return e=e.replaceAll("/","_"),e=e.replaceAll("+","-"),e}(i)}function n(t){let e=function(t){let e=t;return e=e.replaceAll("_","/"),e=e.replaceAll("-","+"),window.atob(e)}(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}function d(t,e){let i=1;for(;e&127<<7*i;)i+=1;let s=new Uint8Array(i);for(let t=0;t<i;t++)s[t]=(e&127<<7*t)>>7*t|(t==i-1?128:0);return g(s.buffer,t)}function c(t){let e=new Uint8Array(t),i=0,s=0;for(const[t,h]of e.entries())if(i|=(127&h)<<7*t,s+=1,128&h)break;return{num:i,buffer:t.slice(s)}}function u(t){let e=[];for(;t.byteLength>0;){let i=c(t),s=i.num;e.push(i.buffer.slice(0,s)),t=i.buffer.slice(s)}return e}function g(t,e){var i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer}Array.prototype.containsArray=function(t){for(var e={},i=0;i<this.length;i++)e[this[i]]=i;return e.hasOwnProperty(t)}}},e={};function i(s){var h=e[s];if(void 0!==h)return h.exports;var a=e[s]={exports:{}};return t[s](a,a.exports,i),a.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i(221),i(643)})();