(()=>{var t={961:(t,e,i)=>{var s,h=function(){var t=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",s={};function h(t,e){if(!s[t]){s[t]={};for(var i=0;i<t.length;i++)s[t][t.charAt(i)]=i}return s[t][e]}var r={compressToBase64:function(t){if(null==t)return"";var i=r._compress(t,6,(function(t){return e.charAt(t)}));switch(i.length%4){default:case 0:return i;case 1:return i+"===";case 2:return i+"==";case 3:return i+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:r._decompress(t.length,32,(function(i){return h(e,t.charAt(i))}))},compressToUTF16:function(e){return null==e?"":r._compress(e,15,(function(e){return t(e+32)}))+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:r._decompress(t.length,16384,(function(e){return t.charCodeAt(e)-32}))},compressToUint8Array:function(t){for(var e=r.compress(t),i=new Uint8Array(2*e.length),s=0,h=e.length;s<h;s++){var a=e.charCodeAt(s);i[2*s]=a>>>8,i[2*s+1]=a%256}return i},decompressFromUint8Array:function(e){if(null==e)return r.decompress(e);for(var i=new Array(e.length/2),s=0,h=i.length;s<h;s++)i[s]=256*e[2*s]+e[2*s+1];var a=[];return i.forEach((function(e){a.push(t(e))})),r.decompress(a.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":r._compress(t,6,(function(t){return i.charAt(t)}))},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),r._decompress(t.length,32,(function(e){return h(i,t.charAt(e))})))},compress:function(e){return r._compress(e,16,(function(e){return t(e)}))},_compress:function(t,e,i){if(null==t)return"";var s,h,r,a={},o={},l="",n="",c="",d=2,u=3,p=2,f=[],g=0,y=0;for(r=0;r<t.length;r+=1)if(l=t.charAt(r),Object.prototype.hasOwnProperty.call(a,l)||(a[l]=u++,o[l]=!0),n=c+l,Object.prototype.hasOwnProperty.call(a,n))c=n;else{if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;s<p;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(h=c.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1}else{for(h=1,s=0;s<p;s++)g=g<<1|h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h=0;for(h=c.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1}0==--d&&(d=Math.pow(2,p),p++),delete o[c]}else for(h=a[c],s=0;s<p;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1;0==--d&&(d=Math.pow(2,p),p++),a[n]=u++,c=String(l)}if(""!==c){if(Object.prototype.hasOwnProperty.call(o,c)){if(c.charCodeAt(0)<256){for(s=0;s<p;s++)g<<=1,y==e-1?(y=0,f.push(i(g)),g=0):y++;for(h=c.charCodeAt(0),s=0;s<8;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1}else{for(h=1,s=0;s<p;s++)g=g<<1|h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h=0;for(h=c.charCodeAt(0),s=0;s<16;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1}0==--d&&(d=Math.pow(2,p),p++),delete o[c]}else for(h=a[c],s=0;s<p;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1;0==--d&&(d=Math.pow(2,p),p++)}for(h=2,s=0;s<p;s++)g=g<<1|1&h,y==e-1?(y=0,f.push(i(g)),g=0):y++,h>>=1;for(;;){if(g<<=1,y==e-1){f.push(i(g));break}y++}return f.join("")},decompress:function(t){return null==t?"":""==t?null:r._decompress(t.length,32768,(function(e){return t.charCodeAt(e)}))},_decompress:function(e,i,s){var h,r,a,o,l,n,c,d=[],u=4,p=4,f=3,g="",y=[],m={val:s(0),position:i,index:1};for(h=0;h<3;h+=1)d[h]=h;for(a=0,l=Math.pow(2,2),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;switch(a){case 0:for(a=0,l=Math.pow(2,8),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;c=t(a);break;case 1:for(a=0,l=Math.pow(2,16),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;c=t(a);break;case 2:return""}for(d[3]=c,r=c,y.push(c);;){if(m.index>e)return"";for(a=0,l=Math.pow(2,f),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;switch(c=a){case 0:for(a=0,l=Math.pow(2,8),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;d[p++]=t(a),c=p-1,u--;break;case 1:for(a=0,l=Math.pow(2,16),n=1;n!=l;)o=m.val&m.position,m.position>>=1,0==m.position&&(m.position=i,m.val=s(m.index++)),a|=(o>0?1:0)*n,n<<=1;d[p++]=t(a),c=p-1,u--;break;case 2:return y.join("")}if(0==u&&(u=Math.pow(2,f),f++),d[c])g=d[c];else{if(c!==p)return null;g=r+r.charAt(0)}y.push(g),d[p++]=r+g.charAt(0),r=g,0==--u&&(u=Math.pow(2,f),f++)}}};return r}();void 0===(s=function(){return h}.call(e,i,e,t))||(t.exports=s)}},e={};function i(s){var h=e[s];if(void 0!==h)return h.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,i),r.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";i(961);class t{constructor(t,i,h=30,r=2){this.rows=t,this.cols=i,this.tileSize=h,this.spawnArea=r,this.boardHeight=(t+this.spawnArea)*h,this.boardWidth=i*h,this.playfield=new e(this.rows,this.cols,this.tileSize,this.spawnArea),this.hold=new o(this.tileSize),this.queue=new a(this.tileSize),this.sketcher=new s(this.playfield,(()=>this.getActivePiece()),(()=>this.saveState())),this.history=new l,this.activePiece=null,this.isPaused=!1}update(){this.queue.updateQueue(),this.activePiece&&this.activePiece.name===this.queue.getCurrent()||this.spawnPiece()}lstGuide(){let t=t=>this.playfield.board.map((e=>e[t])),e=t=>{for(let e=0;e<t.length;e++)if(t[e].active)return t[e].y;return this.rows+this.spawnArea},i=[];for(let e=0;e<this.cols;e++)i.push(t(e));let s=(t,s)=>{let h=e(i[t]),r=e(i[s]),a=h>=r?i[t]:i[s],o=h>=r?i[s]:i[t],l=e(o);if(h!=r)for(let t=this.rows+this.spawnArea-1;t>=0;t--){let e=a[t];t>=l&&!e.active&&o[t].active||o[t].selected?e.selected=!0:e.selected=!1,t>=l&&(o[t].selected=!1),t<l&&(a[t].selected||o[t].selected)&&(a[t].selected=!0,o[t].selected=!0)}else for(let t=this.rows+this.spawnArea-1;t>=0;t--)a[t].selected=!1,o[t].selected=!1};s(0,4),s(1,3)}getActivePiece(){return this.activePiece}renderBoard(){this.playfield.render(this.isPaused),this.queue.renderQueue(),this.hold.renderHold(),this.renderActive()}renderActive(){if(this.activePiece){let t=this.activePiece.copy();t.color="rgba(50, 50, 50, 0.5)",this.shiftInstant("down",!1,t);for(let e=0;e<t.tiles.length;e++)this.playfield.colorTile(t.tiles[e]);for(let t=0;t<this.activePiece.tiles.length;t++)this.playfield.colorTile(this.activePiece.tiles[t])}}saveState(){this.history.addState(this.playfield.copy(),this.queue.copy(),this.hold.copy())}setState(t){let e=this.history.getState(t);e&&(this.playfield.setField(e),this.queue=e.queue.copy(),this.hold=e.hold.copy(),this.spawnPiece(!1),this.renderBoard())}spawnPiece(t=!0,e=null){let i=Math.ceil(this.cols/2)-2;return this.activePiece=new r(this.queue.getCurrent(),i,0),this.collisionCheck(this.activePiece,this.playfield)?(this.activePiece=null,!1):(t&&this.saveState(),"r"===e?this.shiftInstant("right"):"l"===e&&this.shiftInstant("left"),!0)}holdPiece(){if(this.activePiece)if(this.hold.pieceName){let t=this.hold.getHold();this.hold.setHold(this.activePiece.name),this.queue.setCurrent(t)}else this.hold.setHold(this.activePiece.name),this.queue.queueStep(),this.spawnPiece()}collisionCheck(t,e){for(let i=0;i<t.tiles.length;i++){let s=t.tiles[i];if(s.y<0||s.x<0||s.y>this.rows+this.spawnArea-1||s.x>this.cols-1||e.board[s.y][s.x].active)return!0}return!1}shiftPiece(t,e=this.activePiece){if(e){if("left"===t?e.move(0,-1):"right"===t?e.move(0,1):"down"===t&&e.move(1,0),!this.collisionCheck(e,this.playfield))return!0;"left"===t?e.move(0,1):"right"===t?e.move(0,-1):"down"===t&&e.move(-1,0)}return!1}shiftInstant(t,e=!1,i=this.activePiece){if(i)if("left"===t)for(;this.shiftPiece("left",i);)e&&this.shiftInstant("down",e,i);else if("right"===t)for(;this.shiftPiece("right",i);)e&&this.shiftInstant("down",e,i);else if("down"===t)for(;this.shiftPiece("down",i););}rotateActive(t){if(this.activePiece){let e,i=this.activePiece.rot,s=((this.activePiece.rot+t)%4+4)%4;if(this.activePiece.rotate(s),e="i"===this.activePiece.name?this.kickTable.i[i][s]:this.kickTable.n[i][s],e)for(let t=0;t<e.length;t++){let i=e[t];if(this.activePiece.move(-i[1],i[0]),!this.collisionCheck(this.activePiece,this.playfield))return!0;this.activePiece.move(i[1],-i[0])}this.activePiece.rotate(i)}return!1}hardDrop(t=this.activePiece){if(t){for(;this.shiftPiece("down",t););this.playfield.write(this.activePiece),this.playfield.clearLines(),this.queue.queueStep(),this.spawnPiece()}}resetBoard(){this.playfield.reset(),this.hold.setHold(""),this.queue.reset(),this.history.reset(),this.spawnPiece()}kickTable={n:{0:{0:[[0,0]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],2:[[0,0],[0,1],[1,1],[-1,1],[1,0],[-1,0]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},1:{0:[[0,0],[1,0],[1,-1],[0,2],[1,2]],1:[[0,0]],2:[[0,0],[1,0],[1,-1],[0,2],[1,2]],3:[[0,0],[1,0],[1,2],[1,1],[0,2],[0,1]]},2:{0:[[0,0],[0,-1],[-1,-1],[1,-1],[-1,0],[1,0]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],2:[[0,0]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},3:{0:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],1:[[0,0],[-1,0],[-1,2],[-1,1],[0,2],[0,1]],2:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],3:[[0,0]]}},i:{0:{0:[[0,0]],1:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],2:[[0,0]],3:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},1:{0:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],1:[[0,0]],2:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],3:[[0,0]]},2:{0:[[0,0]],1:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],2:[[0,0]],3:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},3:{0:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],1:[[0,0]],2:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],3:[[0,0]]}}}}class e{constructor(t,e,i,s){this.rows=t,this.cols=e,this.tileSize=i,this.spawnArea=s,this.boardHeight=(t+this.spawnArea)*i,this.boardWidth=e*i,this.board=[];for(let t=0;t<this.rows+this.spawnArea;t++){let e=[];for(let i=0;i<this.cols;i++)e.push(new h(i,t));this.board.push(e)}this.canvas=document.getElementById("field"),this.ctx=this.canvas.getContext("2d"),this.backgroundCanvas=document.getElementById("background"),this.backgroundCtx=this.backgroundCanvas.getContext("2d")}setField(t){this.board=t.playfield.copy().board}getAllTiles(){let t=[];for(let e=0;e<this.rows+this.spawnArea;e++)for(let i=0;i<this.cols;i++)t.push(this.board[e][i]);return t}render(t=!1){this.canvas.width=this.boardWidth,this.canvas.height=this.boardHeight,this.backgroundCanvas.width=this.boardWidth,this.backgroundCanvas.height=this.boardHeight,this.backgroundCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.backgroundCtx.strokeStyle="black",this.backgroundCtx.globalAlpha=.6,this.backgroundCtx.fillRect(0,0,this.canvas.width,this.spawnArea*this.tileSize),this.backgroundCtx.globalAlpha=1,this.backgroundCtx.fillRect(0,this.spawnArea*this.tileSize,this.canvas.width,this.canvas.height),this.backgroundCtx.strokeStyle="gray",this.backgroundCtx.globalAlpha=.25,this.backgroundCtx.setLineDash([.25*this.tileSize,.5*this.tileSize,.25*this.tileSize,0]);for(let t=this.spawnArea;t<this.rows+3;t++)this.backgroundCtx.lineWidth=t===this.spawnArea||t===this.rows+this.spawnArea?1:2,this.backgroundCtx.beginPath(),this.backgroundCtx.moveTo(0,t*this.tileSize),this.backgroundCtx.lineTo(this.boardWidth,t*this.tileSize),this.backgroundCtx.stroke();for(let t=0;t<this.cols+1;t++)this.backgroundCtx.lineWidth=0===t||t===this.cols?1:2,this.backgroundCtx.beginPath(),this.backgroundCtx.moveTo(t*this.tileSize,this.spawnArea*this.tileSize),this.backgroundCtx.lineTo(t*this.tileSize,this.boardHeight),this.backgroundCtx.stroke();this.backgroundCtx.globalAlpha=1;for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&this.colorTile(i)}for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&i.selected&&(this.ctx.fillStyle="rgba(200,200,200, 1)",this.ctx.fillRect(e*this.tileSize-2,t*this.tileSize-2,this.tileSize+4,this.tileSize+4))}for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++){let i=this.board[t][e];i&&i.selected&&(i.active?this.colorTile(i):this.ctx.clearRect(e*this.tileSize,t*this.tileSize,this.tileSize,this.tileSize))}t&&(this.ctx.fillStyle="black",this.ctx.globalAlpha=.4,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="gray",this.ctx.globalAlpha=.6,this.ctx.fillRect(.5*this.canvas.width-30,.5*this.canvas.height-30,20,60),this.ctx.fillRect(.5*this.canvas.width+10,.5*this.canvas.height-30,20,60))}write(t){for(let e=0;e<t.tiles.length;e++){let i=t.tiles[e];this.board[i.y][i.x].active=!0,this.board[i.y][i.x].color=t.color}}colorTile(t,e=t.color){t.color&&t.active&&(this.ctx.fillStyle=e,this.ctx.fillRect(t.x*this.tileSize,t.y*this.tileSize,this.tileSize,this.tileSize))}isFull(t){for(let e=0;e<t.length;e++)if(!t[e].active)return!1;return!0}clearLines(){let t=[],e=0;for(let i=this.board.length-1;i>=0;i--){let s=this.board[i];if(this.isFull(s))e+=1;else{for(let t=0;t<s.length;t++)s[t].y+=e;t.push(s)}}let i=[];for(let t=0;t<e;t++){let e=[];for(let i=0;i<this.cols;i++)e.push(new h(i,t));i.push(e)}this.board=[...i,...t.reverse()]}reset(){for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++)this.board[t][e].active=!1}copy(){let t=new e(this.rows,this.cols,this.tileSize,this.spawnArea);t.board=[];for(let e=0;e<this.rows+this.spawnArea;e++){let i=[];for(let t=0;t<this.cols;t++)i.push(this.board[e][t].copy());t.board.push(i)}return t}}class s{palette=[];mouseDown=!1;shiftKey=!1;drawColor="#888888";drawMode=!1;drawRectStart;selected=[];selectMode=!0;selectionOffsets=[];selectRectStart;startDragTile;dragBounds={};mode=null;constructor(t,e,i){this.playfield=t,this.canvas=this.playfield.canvas,this.getActivePiece=e,this.saveState=i;let s=document.getElementById("palette"),h=Object.entries(r.pieces).map((t=>t[1].color));h.push("#888888");let a=0;for(const t of h){let e=document.createElement("div");e.id="color-"+a,e.style.background=t,e.style.height="40px",e.style.width="40px",e.style.margin="10px",e.style.border="5px solid transparent",7==a&&(e.style.borderColor="white"),s.appendChild(e),this.palette.push(e),e.addEventListener("mousedown",(t=>{this.drawColor=t.target.style.background,this.updatePalette()})),a++}document.addEventListener("mousedown",(t=>{this.mouseDown=!0})),document.addEventListener("mouseup",(t=>{this.mouseDown=!1})),this.canvas.addEventListener("mousedown",(t=>{this.mouseDown=!0;let e=this.getTile(t.offsetX,t.offsetY);if(e)if(1===t.button)e.active&&(this.drawColor=e.color,this.updatePalette());else if(this.shiftKey)this.mode="select",this.selectMode=!e.selected,2===t.button?(this.selectRectStart=[e.x,e.y],this.selectRect(this.selectRectStart,[e.x,e.y],this.selectMode)):this.select(e,this.selectMode);else if(e.selected){this.mode="drag",this.startDragTile=e,this.selected=this.playfield.getAllTiles().filter((t=>t.selected)).map((t=>t.copy())),this.selectionOffsets=this.selected.map((t=>({x:t.x-this.startDragTile.x,y:t.y-this.startDragTile.y})),this);let t=Math.min(...this.selected.map((t=>t.x))),i=Math.min(...this.selected.map((t=>t.y))),s=Math.max(...this.selected.map((t=>t.x))),h=Math.max(...this.selected.map((t=>t.y)));this.dragBounds={lowX:this.startDragTile.x-t,highX:this.startDragTile.x+(this.playfield.cols-1)-s,lowY:this.startDragTile.y-i,highY:this.startDragTile.y+(this.playfield.rows+this.playfield.spawnArea-1)-h},this.drag(e)}else this.mode="draw",this.drawMode=!e.active,e.color=this.drawMode?this.drawColor:null,3===t.which?(this.drawRectStart=[e.x,e.y],this.drawRect(this.drawRectStart,[e.x,e.y])):this.draw(e)})),this.canvas.addEventListener("mousemove",(t=>{let e=this.getTile(t.offsetX,t.offsetY);e&&("draw"===this.mode?3===t.which?this.drawRect(this.drawRectStart,[e.x,e.y]):this.draw(e):"select"===this.mode?3===t.which?this.selectRect(this.selectRectStart,[e.x,e.y],this.selectMode):this.select(e,this.selectMode):"drag"===this.mode&&this.mouseDown&&this.drag(e))})),this.canvas.addEventListener("mouseup",(t=>{this.getTile(t.offsetX,t.offsetY)&&(this.mouseDown=!1,"drag"===this.mode&&(this.mode="select"),this.saveState())})),this.canvas.addEventListener("contextmenu",(t=>t.preventDefault()))}static colorComp(t,e){if(!t||!e)return!1;const i=t=>{if("r"!=t[0])return!1;let[e,i,s]=t.split("(")[1].split(")")[0].split(",").map((t=>parseInt(t)));return"#"+[e,i,s].map((t=>{const e=t.toString(16);return 1===e.length?"0"+e:e})).join("")};return t==e||i(t)==e||i(e)==t}getTile(t,e){let i=Math.floor(t/this.playfield.tileSize),s=Math.floor(e/this.playfield.tileSize);return i=Math.min(i,this.playfield.cols-1),s=Math.min(s,this.playfield.rows+this.playfield.spawnArea-1),this.playfield.board[s][i]}isActive(t){let e=this.getActivePiece();if(e)for(let i=0;i<e.tiles.length;i++)if(t.samePos(e.tiles[i]))return!0;return!1}updatePalette(){console.log(" ");for(const t of this.palette)s.colorComp(this.drawColor,t.style.background)?t.style.borderColor="white":t.style.borderColor="transparent"}draw(t){this.mouseDown&&!this.isActive(t)&&(t.active=this.drawMode,t.color=this.drawMode?this.drawColor:null)}drawRect(t,e){let i=Math.min(t[0],e[0]),s=Math.min(t[1],e[1]),h=Math.max(t[0],e[0]),r=Math.max(t[1],e[1]);for(let t=s;t<=r;t++)for(let e=i;e<=h;e++){let i=this.playfield.board[t][e];i.active=this.drawMode,i.color=this.drawMode?this.drawColor:null}}select(t,e=!0){this.shiftKey&&this.mouseDown&&(t.selected=e)}selectRect(t,e,i){let s=Math.min(t[0],e[0]),h=Math.min(t[1],e[1]),r=Math.max(t[0],e[0]),a=Math.max(t[1],e[1]);for(let t=h;t<=a;t++)for(let e=s;e<=r;e++){let s=this.playfield.board[t][e];this.select(s,i)}}unselectAll(){let t=this.playfield.getAllTiles();for(let e=0;e<t.length;e++)t[e].selected=!1}drag(t){if(t!==this.startDragTile){let e=(t,e,i)=>Math.max(Math.min(t,i),e),i=e(t.x,this.dragBounds.lowX,this.dragBounds.highX),s=e(t.y,this.dragBounds.lowY,this.dragBounds.highY);for(let t=0;t<this.selected.length;t++){let e=this.selected[t];this.playfield.board[e.y][e.x].active=!1,this.playfield.board[e.y][e.x].selected=!1}for(let t=0;t<this.selected.length;t++){this.selected[t].x=i+this.selectionOffsets[t].x,this.selected[t].y=s+this.selectionOffsets[t].y;let e=this.selected[t].copy();this.playfield.board[e.y][e.x]=e}}}}class h{constructor(t,e,i=!1,s=null){this.x=t,this.y=e,this.active=i,this.color=s,this.selected=!1}samePos(t){return this.x===t.x&&this.y===t.y}copy(){let t=new h(this.x,this.y,this.active,this.color);return t.selected=this.selected,t}}class r{constructor(t,e=0,i=0,s=0){this.name=t,this.pos={x:e,y:i},this.rot=s,this.offsets=r.pieces[this.name][this.rot],this.color=r.pieces[this.name].color,this.updateTiles()}copy(){return new r(this.name,this.pos.x,this.pos.y,this.rot)}move(t,e){this.pos.y+=t,this.pos.x+=e,this.updateTiles()}rotate(t){this.rot=t,this.offsets=r.pieces[this.name][this.rot],this.updateTiles()}updateTiles(){this.tiles=this.offsets.map((t=>new h(this.pos.x+t[1],this.pos.y+t[0],!0,this.color)))}static pieces={i:{0:[[1,0],[1,1],[1,2],[1,3]],1:[[0,2],[1,2],[2,2],[3,2]],2:[[2,0],[2,1],[2,2],[2,3]],3:[[0,1],[1,1],[2,1],[3,1]],color:"#0f9bd7"},j:{0:[[0,0],[1,0],[1,1],[1,2]],1:[[0,1],[0,2],[1,1],[2,1]],2:[[1,0],[1,1],[1,2],[2,2]],3:[[2,0],[2,1],[1,1],[0,1]],color:"#2141c6"},l:{0:[[1,0],[1,1],[1,2],[0,2]],1:[[0,1],[1,1],[2,1],[2,2]],2:[[1,0],[1,1],[1,2],[2,0]],3:[[0,0],[2,1],[1,1],[0,1]],color:"#e35b02"},o:{0:[[0,1],[0,2],[1,1],[1,2]],1:[[0,1],[0,2],[1,1],[1,2]],2:[[0,1],[0,2],[1,1],[1,2]],3:[[0,1],[0,2],[1,1],[1,2]],color:"#e39f02"},s:{0:[[1,0],[1,1],[0,1],[0,2]],1:[[0,1],[1,1],[1,2],[2,2]],2:[[2,0],[2,1],[1,1],[1,2]],3:[[0,0],[1,0],[1,1],[2,1]],color:"#59b101"},t:{0:[[0,1],[1,0],[1,1],[1,2]],1:[[0,1],[1,1],[1,2],[2,1]],2:[[1,0],[1,1],[1,2],[2,1]],3:[[0,1],[1,0],[1,1],[2,1]],color:"#af298a"},z:{0:[[0,0],[0,1],[1,1],[1,2]],1:[[0,2],[1,1],[1,2],[2,1]],2:[[1,0],[1,1],[2,1],[2,2]],3:[[0,1],[1,1],[1,0],[2,0]],color:"#d70f37"}}}class a{pieces=["i","j","l","t","s","z","o"];queue=[];queueIndex=0;bagStarts=new Set;slots=6;slotSizeY=4;slotSizeX=6;showMax=6;constructor(t=25){this.canvas=document.getElementById("queue"),this.ctx=this.canvas.getContext("2d"),this.tileSize=t,this.queueHeight=this.tileSize*this.slots*this.slotSizeY,this.queueWidth=this.tileSize*this.slotSizeX,this.canvas.height=this.queueHeight,this.canvas.width=this.queueWidth,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.updateQueue(),this.renderQueue()}copy(){let t=new a(this.tileSize);return t.queue=structuredClone(this.queue),t.queueIndex=this.queueIndex,t}renderQueue(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=this.queueIndex+1;t<this.queueIndex+8;t++)t<this.queueIndex+this.showMax&&this.drawPiece(new r(this.queue[t]),this.tileSize,this.tileSize+3*(t-(this.queueIndex+1))*this.tileSize),this.ctx.lineWidth=2,this.ctx.strokeStyle=t%7==6?"rgba(200,200,200,0.5)":"rgba(100,100,100,0.2)",this.ctx.beginPath(),this.ctx.moveTo(this.queueWidth-20,3*(t-(this.queueIndex+1)+1)*this.tileSize+this.tileSize/2),this.ctx.lineTo(this.queueWidth,3*(t-(this.queueIndex+1)+1)*this.tileSize+this.tileSize/2),this.ctx.stroke()}drawPiece(t,e,i){for(let s=0;s<t.offsets.length;s++){let h=t.offsets[s],r=e+h[1]*this.tileSize,a=i+h[0]*this.tileSize;this.ctx.fillStyle=t.color,this.ctx.fillRect(r,a,this.tileSize,this.tileSize)}}updateQueue(t=[]){for(t.length>0&&(this.queue=this.queue.slice(0,this.queueIndex),this.queue=[...this.queue,...t]);this.queue.length-this.queueIndex<=this.showMax;){let t=t=>{let e=structuredClone(t);for(let t=e.length-1;t>0;t--){let i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e};this.queue.push(...t(Object.entries(r.pieces).map((t=>t[0]))))}return!0}setQueueIndex(t){this.queueIndex=t}queueStep(){this.updateQueue(),this.queueIndex+=1}getCurrent(){return this.queue[this.queueIndex]}setCurrent(t){this.queue[this.queueIndex]=t}reset(){this.queue=[],this.queueIndex=0,this.updateQueue()}}class o{pieceName;constructor(t=30){this.canvas=document.getElementById("hold"),this.ctx=this.canvas.getContext("2d"),this.tileSize=t,this.holdHeight=5*this.tileSize,this.holdWidth=6*this.tileSize,this.canvas.height=this.holdHeight,this.canvas.width=this.holdWidth,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderHold()}copy(){let t=new o(this.tileSize);return t.pieceName=this.pieceName,t}renderHold(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.pieceName&&this.drawPiece(new r(this.pieceName),this.tileSize,this.tileSize)}drawPiece(t,e,i){for(let s=0;s<t.offsets.length;s++){let h=t.offsets[s],r=e+h[1]*this.tileSize,a=i+h[0]*this.tileSize;this.ctx.fillStyle=t.color,this.ctx.fillRect(r,a,this.tileSize,this.tileSize)}}getHold(){return this.pieceName}setHold(t){this.pieceName=t}}class l{states=[];stateIndex=null;addState(t,e,i){this.stateIndex<this.states.length-1&&(this.states=this.states.slice(0,this.stateIndex+1));let s={playfield:t,queue:e,hold:i};this.states.push(s),null!==this.stateIndex?this.stateIndex+=1:this.stateIndex=0}getState(t=0){if(null!==this.stateIndex)return this.stateIndex=Math.max(Math.min(this.stateIndex+t,this.states.length-1),0),this.states[this.stateIndex]}reset(){this.states=[],this.stateIndex=null}}class n{keysDown={};lastKey=null;settingsCallback;constructor(t){window.addEventListener("keydown",(t=>this.keyDown(t))),window.addEventListener("keyup",(t=>this.keyUp(t))),this.callback=t}keyDown(t){this.keysDown[t.key]||(this.keysDown[t.key]=performance.now(),this.lastKey=t.key,this.callback(t.key,!0))}keyUp(t){this.keysDown[t.key]=null,this.callback(t.key,!1)}}class c{das=130;arr=50;softDrop=20;keybinds={leftKey:"ArrowLeft",rightKey:"ArrowRight",softKey:"ArrowDown",hardKey:" ",holdKey:"c",crKey:"ArrowUp",ccrKey:"z",r180Key:"a",restartKey:"r",undoKey:"q",redoKey:"w"};constructor(t,e,i,s){this.input=t,this.pause=e,this.resume=i,this.board=s,this.loadSettings();let h=document.getElementById("settings");h.addEventListener("focusin",(t=>this.pause())),h.addEventListener("focusout",(t=>this.resume())),h.innerHTML="";let r="";r+='<div class="setting"><p>update queue</p><input id="queueUpdate"></input></div>',r+='<div id="timing">';for(const[t,e]of Object.entries(this))"das"!==t&&"arr"!==t&&"softDrop"!==t||(r+='<div class="setting">',r+='<p id="'+t+'Text">'+t+" (ms) : "+e+"</p>",r+='<input id="'+t+'Field"></input>',r+="</div>");r+="</div>",r+='<div id="keyBinds">',r+='<button id="changeAll"> Change All Keybinds</button>';for(const[t,e]of Object.entries(this.keybinds))r+='<div class="setting">',r+='<p id="'+t+'Text" >'+t+" : </p>",r+='<p id="'+t+'">'+(" "===e?"Space":e)+"</p>",r+='<button id ="'+t+'Button">change</button>',r+="</div>";r+="</div>",document.getElementById("settings").innerHTML+=r,document.getElementById("queueUpdate").addEventListener("keyup",(t=>{if("Enter"===t.key){let t=document.getElementById("queueUpdate").value.split(""),e=["i","j","l","t","s","z","o"];for(let i=0;i<t.length;i++)if(!e.includes(t[i]))return;this.board.queue.updateQueue(t),this.board.hold.setHold(null),document.getElementById("queueUpdate").value="",document.getElementById("queueUpdate").blur()}}));for(const[t,e]of Object.entries(this))"das"!==t&&"arr"!==t&&"softDrop"!==t||document.getElementById(t+"Field").addEventListener("keyup",(e=>{"Enter"===e.key&&(this.update(t,document.getElementById(t+"Field").value),document.getElementById(t+"Field").value="",document.getElementById(t+"Field").blur())}));document.getElementById("changeAll").addEventListener("click",(t=>this.changeAllKeys()));for(const[t,e]of Object.entries(this.keybinds))document.getElementById(t+"Button").addEventListener("click",(e=>{document.getElementById(t+"Button").blur(),this.updateKey(t)}))}loadSettings(){let t=decodeURIComponent(document.cookie).split("; ").find((t=>t.startsWith("settings=")));if(t){let e=JSON.parse(t.split("=")[1]);this.das=e.das,this.arr=e.arr,this.softDrop=e.softDrop,this.keybinds=e.keybinds,document.getElementById("settings")}}saveSettings(){let t={das:this.das,arr:this.arr,softDrop:this.softDrop,keybinds:this.keybinds},e=new Date;e.setTime(e.getTime()+31536e6),document.cookie="settings="+encodeURIComponent(JSON.stringify(t))+"; expires="+e.toUTCString()}removeFocus(){document.getElementById("queueUpdate").blur()}updateDisplay(){for(const[t,e]of Object.entries(this))"das"!==t&&"arr"!==t&&"softDrop"!==t||(document.getElementById(t+"Text").innerHTML=t+" (ms) : "+e);for(const[t,e]of Object.entries(this.keybinds))document.getElementById(t).innerHTML=" "===e?"Space":e;this.saveSettings()}async changeAllKeys(){for(const[t,e]of Object.entries(this.keybinds)){document.getElementById(t).innerHTML="Waiting...";let e=await this.awaitKey();this.keybinds[t]=e,this.updateDisplay()}document.getElementById("changeAll").blur()}update(t,e){this[t]=parseInt(e),this.updateDisplay()}async updateKey(t){this.pause(),document.getElementById(t).innerHTML="Waiting...";let e=await this.awaitKey();this.keybinds[t]=e,this.resume(),this.updateDisplay()}awaitKey(){return new Promise((t=>{document.addEventListener("keydown",(e=>{e.preventDefault(),t(e.key)}),{once:!0})}))}}let d=new class{start=!0;startTime;takingInput=!0;curDir;dasFired=!1;softDrop=!1;dasCancel;arrCancel;softCancel;constructor(){this.input=new n(((t,e)=>this.handleInput(t,e))),this.board=new t(20,10,30),this.settings=new c(this.input,(()=>this.pauseInput()),(()=>this.resumeInput()),this.board),this.lastTick=performance.now(),this.lastRender=this.lastTick,this.tickLength=50}update(){this.start&&(this.board.update(),this.dasFired&&0===this.settings.arr&&this.board.shiftInstant(this.curDir))}initiateDas(t,e){this.cancelDas(),this.curDir=e,this.board.shiftPiece(e),this.dasCancel=setTimeout((()=>{this.dasFired=!0,this.input.keysDown[t]?0===this.settings.arr?this.board.shiftInstant(e,0===this.settings.softDrop&&this.softDrop):this.arrCancel=setInterval((()=>{this.input.keysDown[t]?this.board.shiftPiece(e):this.cancelDas()}),this.settings.arr):this.cancelDas()}),this.settings.das)}cancelDas(){this.dasCancel&&clearTimeout(this.dasCancel),this.arrCancel&&clearInterval(this.arrCancel),this.dasFired=!1,this.dasCancel=null,this.arrCancel=null,this.curDir=null}handleInput(t,e){this.takingInput&&("Shift"===t&&(this.board.sketcher.shiftKey=!!e),"Escape"===t&&this.board.sketcher.unselectAll(),t===this.settings.keybinds.leftKey?e?this.initiateDas(t,"left"):"left"===this.curDir&&this.cancelDas():t===this.settings.keybinds.rightKey?e?this.initiateDas(t,"right"):"right"===this.curDir&&this.cancelDas():t===this.settings.keybinds.softKey?e?(this.softDrop=!0,0===this.settings.softDrop&&this.board.shiftInstant("down"),this.softCancel=setInterval((()=>{this.input.keysDown[t]?this.board.shiftPiece("down"):clearInterval(this.softCancel)}),this.settings.softDrop)):this.softDrop&&(this.softDrop=!1,clearInterval(this.softCancel)):e&&t===this.settings.keybinds.hardKey?this.board.hardDrop():e&&t===this.settings.keybinds.holdKey?this.board.holdPiece():e&&t===this.settings.keybinds.crKey?this.board.rotateActive(1):e&&t===this.settings.keybinds.ccrKey?this.board.rotateActive(-1):e&&t===this.settings.keybinds.r180Key?this.board.rotateActive(2):e&&t===this.settings.keybinds.restartKey?this.startGame():e&&t===this.settings.keybinds.undoKey?this.board.setState(-1):e&&t===this.settings.keybinds.redoKey&&this.board.setState(1))}spinBoard(){let t=document.getElementById("gameBoard");0===gsap.getProperty(t,"rotation")&&gsap.timeline().to(t,{rotation:360,duration:2,repeat:-1,ease:"none"}).set(t,{rotation:0})}render(){this.board.renderBoard()}startGame(){this.startTime=performance.now(),this.board.resetBoard(),this.start=!0}pauseInput(){this.takingInput=!1,this.board.isPaused=!0}resumeInput(){this.takingInput=!0,this.board.isPaused=!1}};!function t(e){d.stopId=window.requestAnimationFrame(t);let i=0;if(e>d.lastTick+d.tickLength){const t=e-d.lastTick;i=Math.floor(t/d.tickLength)}for(let t=0;t<i;t++)d.lastTick+=d.tickLength,d.update(d.lastTick);d.render()}(performance.now())})()})();